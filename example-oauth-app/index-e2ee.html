<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2EE Notes App - Login with Ave</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #32A94C 0%, #1e7a32 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .e2ee-badge {
            background: linear-gradient(135deg, #32A94C 0%, #1e7a32 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 20px;
        }
        
        .login-btn {
            background: #090909;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            background: #222;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .notes-container {
            margin-top: 20px;
        }
        
        .note-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 10px;
        }
        
        .note-input:focus {
            outline: none;
            border-color: #32A94C;
        }
        
        .add-note-btn {
            background: #32A94C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .add-note-btn:hover {
            background: #2d9544;
        }
        
        .note {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            position: relative;
        }
        
        .note-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .note-meta {
            color: #999;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-note-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .delete-note-btn:hover {
            background: #c0392b;
        }
        
        .user-info {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #c33;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .encryption-info {
            background: #e8f5e9;
            border: 2px solid #32A94C;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e7a32;
        }

        .encryption-info strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üîê Secure Notes
        </h1>
        <div class="e2ee-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z" fill="white"/>
            </svg>
            End-to-End Encrypted
        </div>
        <p>Your notes are encrypted with keys only you control. Not even the server can read them.</p>
        
        <div id="logged-out" style="display: none;">
            <button class="login-btn" onclick="loginWithAve()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 5C13.66 5 15 6.34 15 8C15 9.66 13.66 11 12 11C10.34 11 9 9.66 9 8C9 6.34 10.34 5 12 5ZM12 19.2C9.5 19.2 7.29 17.92 6 15.98C6.03 13.99 10 12.9 12 12.9C13.99 12.9 17.97 13.99 18 15.98C16.71 17.92 14.5 19.2 12 19.2Z" fill="white"/>
                </svg>
                Login with Ave to Access Your Notes
            </button>
        </div>
        
        <div id="loading" style="display: none;">
            <div class="loading">
                <p>Setting up encryption...</p>
            </div>
        </div>
        
        <div id="logged-in" style="display: none;">
            <div class="user-info">
                <div class="user-details">
                    <img id="user-avatar" class="avatar" style="display: none;" />
                    <div>
                        <div style="font-weight: 600; color: #333;" id="user-name"></div>
                        <div style="font-size: 14px; color: #666;" id="user-handle"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="encryption-info">
                <strong>üîë Encryption Active</strong>
                Your notes are encrypted with an app-specific key provided by Ave. This key is stored encrypted on Ave's servers and decrypted each time you log in.
            </div>

            <div class="notes-container">
                <textarea 
                    class="note-input" 
                    id="note-content" 
                    placeholder="Write a secret note..."
                ></textarea>
                <button class="add-note-btn" onclick="addNote()">
                    Add Encrypted Note
                </button>

                <div id="notes-list"></div>
            </div>
        </div>
        
        <div id="error" style="display: none;" class="error"></div>
    </div>

    <script>
        // Configuration
        const AVE_AUTH_URL = 'http://localhost:5173/authorize';
        const AVE_TOKEN_URL = 'http://localhost:3000/api/oauth/token';
        const CLIENT_ID = 'app_4b21fc0238997355796b796c974f9646'; // Must be an app with supports_e2ee = true
        const REDIRECT_URI = 'http://localhost:8000/index-e2ee.html';
        
        // App state
        let appEncryptionKey = null; // The app-specific encryption key from Ave
        let notes = []; // Decrypted notes in memory
        
        // PKCE Helper Functions
        function base64UrlEncode(arrayBuffer) {
            const bytes = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }
        
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64UrlEncode(hash);
        }
        
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Encryption Functions
        async function generateAppKey() {
            // Generate a new encryption key for this app
            return await crypto.subtle.generateKey(
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function exportKey(key) {
            const exported = await crypto.subtle.exportKey('raw', key);
            return base64UrlEncode(exported);
        }

        async function importKey(keyString) {
            const binaryString = atob(keyString.replace(/-/g, '+').replace(/_/g, '/'));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return await crypto.subtle.importKey(
                'raw',
                bytes,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptData(key, data) {
            const encoder = new TextEncoder();
            const dataBytes = encoder.encode(data);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                dataBytes
            );
            
            // Combine IV and ciphertext
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            
            return base64UrlEncode(combined);
        }

        async function decryptData(key, encryptedData) {
            const binaryString = atob(encryptedData.replace(/-/g, '+').replace(/_/g, '/'));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            const iv = bytes.slice(0, 12);
            const ciphertext = bytes.slice(12);
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                ciphertext
            );
            
            const decoder = new TextDecoder();
            return decoder.decode(decrypted);
        }
        
        // OAuth Flow
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showError('Authorization denied: ' + error);
                showLoggedOut();
                return;
            }
            
            if (code) {
                showLoading();
                await exchangeCodeForToken(code);
            } else {
                const storedUser = localStorage.getItem('user_data');
                const storedKey = localStorage.getItem('app_encryption_key');
                
                if (storedUser && storedKey) {
                    try {
                        appEncryptionKey = await importKey(storedKey);
                        await loadNotes();
                        showLoggedIn(JSON.parse(storedUser));
                    } catch (e) {
                        console.error('Failed to load app state:', e);
                        showLoggedOut();
                    }
                } else {
                    showLoggedOut();
                }
            }
        });
        
        async function loginWithAve() {
            try {
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                const state = generateRandomString(32);
                
                localStorage.setItem('code_verifier', codeVerifier);
                localStorage.setItem('oauth_state', state);
                
                const params = new URLSearchParams({
                    client_id: CLIENT_ID,
                    redirect_uri: REDIRECT_URI,
                    scope: 'profile',
                    state: state,
                    code_challenge: codeChallenge,
                    code_challenge_method: 'S256'
                });
                
                window.location.href = AVE_AUTH_URL + '?' + params.toString();
            } catch (error) {
                showError('Failed to start login: ' + error.message);
            }
        }
        
        async function exchangeCodeForToken(code) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const returnedState = urlParams.get('state');
                const storedState = localStorage.getItem('oauth_state');
                
                if (returnedState !== storedState) {
                    throw new Error('State mismatch - possible CSRF attack');
                }
                
                const codeVerifier = localStorage.getItem('code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found');
                }
                
                // Check for app key in URL fragment (passed securely by Ave)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const appKeyFromAve = hashParams.get('app_key');
                
                const response = await fetch(AVE_TOKEN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grantType: 'authorization_code',
                        code: code,
                        redirectUri: REDIRECT_URI,
                        clientId: CLIENT_ID,
                        codeVerifier: codeVerifier,
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || 'Token exchange failed');
                }
                
                const data = await response.json();
                
                // Get app encryption key from Ave (passed via URL fragment)
                if (appKeyFromAve) {
                    // Ave provided the app key - use it
                    appEncryptionKey = await importKey(appKeyFromAve);
                    localStorage.setItem('app_encryption_key', appKeyFromAve);
                    console.log('Using app key from Ave');
                } else {
                    // Fallback: check if we have a stored key (shouldn't happen normally)
                    const storedKey = localStorage.getItem('app_encryption_key');
                    if (storedKey) {
                        appEncryptionKey = await importKey(storedKey);
                        console.log('Using stored app key');
                    } else {
                        throw new Error('No app encryption key received from Ave');
                    }
                }
                
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('user_data', JSON.stringify(data.user));
                
                localStorage.removeItem('code_verifier');
                localStorage.removeItem('oauth_state');
                
                // Clean URL (remove query params and hash)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                await loadNotes();
                showLoggedIn(data.user);
                
            } catch (error) {
                console.error('Token exchange failed:', error);
                showError(error.message);
                showLoggedOut();
            }
        }
        
        // Notes Management
        async function loadNotes() {
            // Load encrypted notes from localStorage (in real app, from server)
            const encryptedNotes = JSON.parse(localStorage.getItem('encrypted_notes') || '[]');
            
            // Decrypt all notes
            notes = [];
            for (const encNote of encryptedNotes) {
                try {
                    const decryptedContent = await decryptData(appEncryptionKey, encNote.content);
                    notes.push({
                        id: encNote.id,
                        content: decryptedContent,
                        timestamp: encNote.timestamp
                    });
                } catch (e) {
                    console.error('Failed to decrypt note:', e);
                }
            }
            
            renderNotes();
        }
        
        async function addNote() {
            const content = document.getElementById('note-content').value.trim();
            if (!content) return;
            
            try {
                // Encrypt the note
                const encryptedContent = await encryptData(appEncryptionKey, content);
                
                const note = {
                    id: Date.now(),
                    content: encryptedContent,
                    timestamp: new Date().toISOString()
                };
                
                // Store encrypted (in real app, send to server)
                const encryptedNotes = JSON.parse(localStorage.getItem('encrypted_notes') || '[]');
                encryptedNotes.push(note);
                localStorage.setItem('encrypted_notes', JSON.stringify(encryptedNotes));
                
                // Add to decrypted notes in memory
                notes.push({
                    id: note.id,
                    content: content,
                    timestamp: note.timestamp
                });
                
                document.getElementById('note-content').value = '';
                renderNotes();
            } catch (e) {
                showError('Failed to encrypt note: ' + e.message);
            }
        }
        
        async function deleteNote(id) {
            // Remove from encrypted storage
            const encryptedNotes = JSON.parse(localStorage.getItem('encrypted_notes') || '[]');
            const filtered = encryptedNotes.filter(n => n.id !== id);
            localStorage.setItem('encrypted_notes', JSON.stringify(filtered));
            
            // Remove from memory
            notes = notes.filter(n => n.id !== id);
            renderNotes();
        }
        
        function renderNotes() {
            const notesList = document.getElementById('notes-list');
            
            if (notes.length === 0) {
                notesList.innerHTML = '<p style="color: #999; text-align: center; margin-top: 30px;">No notes yet. Add your first encrypted note above!</p>';
                return;
            }
            
            notesList.innerHTML = notes.map(note => `
                <div class="note">
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-meta">
                        <span>${new Date(note.timestamp).toLocaleString()}</span>
                        <button class="delete-note-btn" onclick="deleteNote(${note.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function logout() {
            // Only clear session data, keep encrypted notes and app key
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('code_verifier');
            localStorage.removeItem('oauth_state');
            // Keep: encrypted_notes, app_encryption_key
            
            notes = [];
            appEncryptionKey = null;
            showLoggedOut();
        }
        
        // UI Functions
        function showLoggedOut() {
            document.getElementById('logged-out').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('logged-in').style.display = 'none';
        }
        
        function showLoading() {
            document.getElementById('logged-out').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('logged-in').style.display = 'none';
        }
        
        function showLoggedIn(user) {
            document.getElementById('logged-out').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('logged-in').style.display = 'block';
            
            document.getElementById('user-name').textContent = user.displayName;
            document.getElementById('user-handle').textContent = '@' + user.handle;
            
            if (user.avatarUrl) {
                const avatarImg = document.getElementById('user-avatar');
                avatarImg.src = user.avatarUrl;
                avatarImg.style.display = 'block';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
