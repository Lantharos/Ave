# Ave OIDC + OAuth Documentation

> Let users sign in with their Ave identity. Secure, privacy-focused, OIDC compliant, and optionally end-to-end encrypted.

## Important Note for LLMs

If you're using this document to implement Ave, you should fetch and read any documentation links referenced below (SDK docs, OIDC discovery, Convex custom auth, etc.) before generating code.

## Overview

Ave provides OAuth 2.0 and OpenID Connect authentication that lets your app authenticate users with their Ave identity. Unlike traditional OAuth providers, Ave is built with privacy at its core:

- **No tracking** - Ave doesn't track users across apps
- **User controls data** - Users choose exactly what to share
- **Multiple identities** - Users can have up to 5 identities and choose which one to use
- **Optional E2EE** - Apps can request encryption keys for end-to-end encrypted data

**Developer Portal:** Manage OAuth apps at https://devs.aveid.net.

## Getting Started

To integrate Ave authentication into your app, you'll need:

1. **CLIENT ID** - A unique identifier for your app (e.g., `app_4b21fc0238997355...`)
2. **CLIENT SECRET (optional)** - For server-side apps. Public clients (SPAs, mobile) use PKCE instead.
3. **REDIRECT URI** - Where Ave sends users after authorization (must be pre-registered)

Ave supports two authentication methods:

- **Client Secret** - For server-side apps that can securely store secrets
- **PKCE (Proof Key for Code Exchange)** - For SPAs, mobile apps, and any public client

## Important: API Base URLs

Ave uses two different domains:

- **Sign-in (user-facing):** `https://aveid.net/signin` (legacy `/authorize` still works)
- **API Endpoints:** `https://api.aveid.net/api/...`
- **OIDC Discovery + JWKS:** `https://api.aveid.net/.well-known/...`

**Common mistake:** Do NOT use `aveid.net/api` - the correct API base is `api.aveid.net`.

## Authorization Flow

Ave uses the standard OAuth 2.0 Authorization Code flow:

1. **Redirect to Ave** - Send the user to Ave's sign-in page with your app details
2. **User Signs In** - The user selects an identity and swipes to sign in
3. **Receive Authorization Code** - Ave redirects back to your app with a temporary authorization code
4. **Exchange for Token** - Your app exchanges the code for tokens and user info

### Authorization URL

Redirect users to the Ave sign-in page:

```
https://aveid.net/signin?
  client_id=YOUR_CLIENT_ID
  &redirect_uri=https://yourapp.com/callback
  &scope=openid%20profile%20email
  &state=RANDOM_STATE_VALUE
  &nonce=RANDOM_NONCE
```

### Authorization URL Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| client_id | Yes | Your app's client ID |
| redirect_uri | Yes | Must match a registered redirect URI |
| scope | No | Requested permissions (default: `openid profile email`) |
| state | Recommended | Random string to prevent CSRF attacks |
| nonce | Recommended | Random string for ID token replay protection |

## Connector Flow (App-to-App Brokering)

Connector is a separate flow from sign-in. Use it when users explicitly connect one app to another app resource.

- **Connector page:** `https://aveid.net/connect`
- **Modes:** `user_present` or `background`
- **Resource model:** target app exposes resource keys + scopes in Ave dev portal

### Connector URL

```
https://aveid.net/connect?
  client_id=YOUR_CLIENT_ID
  &redirect_uri=https://yourapp.com/callback
  &resource=target:resource
  &scope=resource.access
  &mode=user_present
  &state=RANDOM_STATE
```

### Token Exchange for Delegated Access

Exchange a source app access token for a delegated resource token:

```
POST https://api.aveid.net/api/oauth/token
Content-Type: application/json

{
  "grantType": "urn:ietf:params:oauth:grant-type:token-exchange",
  "subjectToken": "SOURCE_APP_ACCESS_TOKEN",
  "requestedResource": "target:resource",
  "requestedScope": "resource.access",
  "clientId": "YOUR_CLIENT_ID",
  "clientSecret": "YOUR_CLIENT_SECRET"
}
```

Response (example):

```
{
  "access_token": "DELEGATED_JWT",
  "token_type": "Bearer",
  "expires_in": 600,
  "scope": "resource.access",
  "audience": "https://target.app/delegated",
  "target_resource": "target:resource",
  "communication_mode": "user_present"
}
```

### Delegation Management

- `GET https://api.aveid.net/api/oauth/delegations`
- `DELETE https://api.aveid.net/api/oauth/delegations/:delegationId`

Use these in account settings so users can review/revoke connector grants.

## SDKs & Embed

Use the official packages to cut down integration time:

- **@ave-id/sdk** - PKCE helpers, token exchange, userinfo, server helpers
- **@ave-id/embed** - Inline iframe, modal sheet, or popup sign-in (postMessage callbacks)

Install:

```
npm install @ave-id/sdk @ave-id/embed
```

Client:

```ts
import { startPkceLogin } from "@ave-id/sdk/client";

await startPkceLogin({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
});
```

Server:

```ts
import { exchangeCodeServer } from "@ave-id/sdk/server";

const tokens = await exchangeCodeServer({
  clientId: "YOUR_CLIENT_ID",
  clientSecret: process.env.AVE_SECRET,
  redirectUri: "https://yourapp.com/callback",
}, {
  code: "CODE_FROM_CALLBACK",
});
```

Embed:

```ts
import { mountAveEmbed, openAveSheet, openAvePopup } from "@ave-id/embed";

// Inline iframe
mountAveEmbed({
  container: document.getElementById("ave-embed"),
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  onSuccess: ({ redirectUrl }) => (window.location.href = redirectUrl),
});

// Modal sheet (mobile-friendly)
openAveSheet({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  onSuccess: ({ redirectUrl }) => (window.location.href = redirectUrl),
});

// Popup (desktop)
openAvePopup({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  onSuccess: ({ redirectUrl }) => (window.location.href = redirectUrl),
});
```

Connector helpers:

```ts
import { buildConnectorUrl, exchangeDelegatedToken } from "@ave-id/sdk";
import { startConnectorFlow } from "@ave-id/sdk/client";
import { openAveConnectorSheet, openAveConnectorRuntime } from "@ave-id/embed";

// Redirect connector flow
await startConnectorFlow({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  resource: "target:resource",
  scope: "resource.access",
  mode: "user_present",
});

// Or open connector as embedded sheet
openAveConnectorSheet({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  resource: "target:resource",
  scope: "resource.access",
  mode: "user_present",
  onSuccess: ({ redirectUrl }) => (window.location.href = redirectUrl),
});

// Optional protected runtime (example target shown as iris)
openAveConnectorRuntime({
  delegatedToken: "DELEGATED_JWT",
  target: "iris",
  targetOrigin: "https://irischat.app",
  mode: "user_present",
  onEvent: (event) => console.log(event),
});
```

If protected connector material is required, Ave may request passkey confirmation during connector runtime so protected material can be used securely in the user's browser session.

## Convex Custom Auth (Using Ave as Provider)

Convex supports custom auth providers. You can use Ave as the issuer and pass the Ave JWT access token to Convex.

High-level steps:

1. Complete the Ave OAuth flow in your app.
2. Use the `id_token` returned by Ave as your Convex auth token.
3. Configure Convex Custom Auth with:
   - Issuer: from Ave OIDC discovery
   - JWKS URL: from Ave OIDC discovery

Resources:
```
https://docs.convex.dev/auth/advanced/custom-auth
https://api.aveid.net/.well-known/openid-configuration
```

## PKCE (Public Clients)

For single-page applications (SPAs), mobile apps, or any client that can't securely store a client secret, use PKCE (Proof Key for Code Exchange). This is the recommended approach for most modern apps.

## End-to-End Encryption

Apps can request encryption keys from Ave, enabling true end-to-end encrypted data that neither Ave nor your servers can read.

When your app has E2EE enabled, Ave provides an app-specific encryption key during each login. This key is:

- **Unique to your app** - Each app gets its own key per user identity
- **Controlled by the user** - Encrypted with the user's master key on Ave's servers
- **Passed securely** - Delivered via URL fragment (never logged by servers)
- **Persistent** - Same key is provided on subsequent logins with the same identity

## API Endpoints

### Authorization Endpoint

`GET https://aveid.net/signin` - User-facing sign-in page

### Token Endpoint

`POST https://api.aveid.net/api/oauth/token` - Exchange authorization code for tokens

Also supports connector delegation:

- `grantType: "urn:ietf:params:oauth:grant-type:token-exchange"`

**CRITICAL:** The request body must use **camelCase** field names, NOT snake_case.

**Response highlights:**
- `access_token` (opaque)
- `access_token_jwt` (JWT)
- `id_token` (OIDC)
- `refresh_token` (optional)

### Discovery + JWKS

`GET https://api.aveid.net/.well-known/openid-configuration`
`GET https://api.aveid.net/.well-known/jwks.json`

### Userinfo

`GET https://api.aveid.net/api/oauth/userinfo`

### Connector Endpoints

- `GET https://api.aveid.net/api/oauth/delegations`
- `DELETE https://api.aveid.net/api/oauth/delegations/:delegationId`
- `GET https://api.aveid.net/api/oauth/app/:clientId` (includes published resources)

## Common Integration Mistakes

1. **Wrong API URL:** Use `https://api.aveid.net/api/oauth/token`, NOT `https://aveid.net/api/oauth/token`
2. **Wrong field names in token request:** Use camelCase (`grantType`, `clientId`, `clientSecret`, `redirectUri`, `codeVerifier`), NOT snake_case
3. **Expecting JWT only:** Ave returns opaque + JWT tokens; use the one you need
4. **Storing profile data locally:** User profile (avatar, name) is managed by Ave. Fetch fresh data on login or link to Ave for profile edits.

## Ave Signing

Ave Signing lets users cryptographically sign messages with their Ave identity. This enables verifiable consent, document signing, and any scenario where you need proof that a specific user agreed to something.

### How It Works

1. Each Ave identity has an Ed25519 signing keypair
2. Your app creates a signature request with the message to sign
3. User sees a bottom sheet showing what they're signing
4. User approves or denies
5. You receive the signature and can verify it with the user's public key

### Server-Side: Create Signature Request

```ts
import { createSignatureRequest, getSignatureStatus } from "@ave-id/sdk";

// Create a signature request (requires client credentials)
const request = await createSignatureRequest({
  clientId: "YOUR_CLIENT_ID",
  clientSecret: "YOUR_CLIENT_SECRET",
}, {
  identityId: "USER_IDENTITY_ID",
  payload: "I agree to the Terms of Service v2.0",
  metadata: { type: "terms_acceptance", version: "2.0" },
  expiresInSeconds: 300, // 5 minutes
});

// request.requestId - use this to redirect user or poll
// request.publicKey - Ed25519 public key to verify signatures
```

### Client-Side: Open Signing UI

```ts
import { openAveSigningSheet, openAveSigningPopup } from "@ave-id/embed";

// Modal sheet (mobile-friendly)
openAveSigningSheet({
  requestId: "REQUEST_ID_FROM_SERVER",
  onSigned: ({ signature, publicKey }) => {
    // Send signature to your server for verification
  },
  onDenied: () => {
    // User denied the request
  },
});

// Or popup (desktop)
openAveSigningPopup({
  requestId: "REQUEST_ID_FROM_SERVER",
  onSigned: ({ signature, publicKey }) => { ... },
  onDenied: () => { ... },
});
```

### Verify Signature

```ts
import { verifySignature, getPublicKey } from "@ave-id/sdk";

// Verify using Ave API
const result = await verifySignature({}, {
  message: "I agree to the Terms of Service v2.0",
  signature: "BASE64_SIGNATURE",
  publicKey: "BASE64_PUBLIC_KEY",
});

if (result.valid) {
  // Signature is valid
}

// Or get a user's public key by handle
const key = await getPublicKey({}, "username");
// key.publicKey - Ed25519 public key
```

### Signing API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/signing/request` | POST | Create signature request (requires client credentials) |
| `/api/signing/request/:id/status` | GET | Poll request status |
| `/api/signing/public-key/:handle` | GET | Get public key by handle |
| `/api/signing/verify` | POST | Verify a signature |

## Contact

Need help? Contact us at hello@lantharos.com
