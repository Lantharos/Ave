# Ave OIDC + OAuth Documentation

> Let users sign in with their Ave identity. Secure, privacy-focused, OIDC compliant, and optionally end-to-end encrypted.

## Overview

Ave provides OAuth 2.0 and OpenID Connect authentication that lets your app authenticate users with their Ave identity. Unlike traditional OAuth providers, Ave is built with privacy at its core:

- **No tracking** - Ave doesn't track users across apps
- **User controls data** - Users choose exactly what to share
- **Multiple identities** - Users can have up to 5 identities and choose which one to use
- **Optional E2EE** - Apps can request encryption keys for end-to-end encrypted data

**Developer Portal:** Manage OAuth apps at https://devs.aveid.net.

## Getting Started

To integrate Ave authentication into your app, you'll need:

1. **CLIENT ID** - A unique identifier for your app (e.g., `app_4b21fc0238997355...`)
2. **CLIENT SECRET (optional)** - For server-side apps. Public clients (SPAs, mobile) use PKCE instead.
3. **REDIRECT URI** - Where Ave sends users after authorization (must be pre-registered)

Ave supports two authentication methods:

- **Client Secret** - For server-side apps that can securely store secrets
- **PKCE (Proof Key for Code Exchange)** - For SPAs, mobile apps, and any public client

## Important: API Base URLs

Ave uses two different domains:

- **Sign-in (user-facing):** `https://aveid.net/signin` (legacy `/authorize` still works)
- **API Endpoints:** `https://api.aveid.net/api/...`
- **OIDC Discovery + JWKS:** `https://api.aveid.net/.well-known/...`

**Common mistake:** Do NOT use `aveid.net/api` - the correct API base is `api.aveid.net`.

## Authorization Flow

Ave uses the standard OAuth 2.0 Authorization Code flow:

1. **Redirect to Ave** - Send the user to Ave's sign-in page with your app details
2. **User Signs In** - The user selects an identity and swipes to sign in
3. **Receive Authorization Code** - Ave redirects back to your app with a temporary authorization code
4. **Exchange for Token** - Your app exchanges the code for tokens and user info

### Authorization URL

Redirect users to the Ave sign-in page:

```
https://aveid.net/signin?
  client_id=YOUR_CLIENT_ID
  &redirect_uri=https://yourapp.com/callback
  &scope=openid%20profile%20email
  &state=RANDOM_STATE_VALUE
  &nonce=RANDOM_NONCE
```

### Authorization URL Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| client_id | Yes | Your app's client ID |
| redirect_uri | Yes | Must match a registered redirect URI |
| scope | No | Requested permissions (default: `openid profile email`) |
| state | Recommended | Random string to prevent CSRF attacks |
| nonce | Recommended | Random string for ID token replay protection |

## SDKs & Embed

Use the official packages to cut down integration time:

- **@ave-id/sdk** - PKCE helpers, token exchange, userinfo, server helpers
- **@ave-id/embed** - Iframe sign-in with postMessage callbacks

Install:

```
npm install @ave-id/sdk @ave-id/embed
```

Client:

```ts
import { startPkceLogin } from "@ave-id/sdk/client";

await startPkceLogin({
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
});
```

Server:

```ts
import { exchangeCodeServer } from "@ave-id/sdk/server";

const tokens = await exchangeCodeServer({
  clientId: "YOUR_CLIENT_ID",
  clientSecret: process.env.AVE_SECRET,
  redirectUri: "https://yourapp.com/callback",
}, {
  code: "CODE_FROM_CALLBACK",
});
```

Embed:

```ts
import { mountAveEmbed } from "@ave-id/embed";

mountAveEmbed({
  container: document.getElementById("ave-embed"),
  clientId: "YOUR_CLIENT_ID",
  redirectUri: "https://yourapp.com/callback",
  onSuccess: ({ redirectUrl }) => window.location.href = redirectUrl,
});
```

## PKCE (Public Clients)

For single-page applications (SPAs), mobile apps, or any client that can't securely store a client secret, use PKCE (Proof Key for Code Exchange). This is the recommended approach for most modern apps.

## End-to-End Encryption

Apps can request encryption keys from Ave, enabling true end-to-end encrypted data that neither Ave nor your servers can read.

When your app has E2EE enabled, Ave provides an app-specific encryption key during each login. This key is:

- **Unique to your app** - Each app gets its own key per user identity
- **Controlled by the user** - Encrypted with the user's master key on Ave's servers
- **Passed securely** - Delivered via URL fragment (never logged by servers)
- **Persistent** - Same key is provided on subsequent logins with the same identity

## API Endpoints

### Authorization Endpoint

`GET https://aveid.net/signin` - User-facing sign-in page

### Token Endpoint

`POST https://api.aveid.net/api/oauth/token` - Exchange authorization code for tokens

**CRITICAL:** The request body must use **camelCase** field names, NOT snake_case.

**Response highlights:**
- `access_token` (opaque)
- `access_token_jwt` (JWT)
- `id_token` (OIDC)
- `refresh_token` (optional)

### Discovery + JWKS

`GET https://api.aveid.net/.well-known/openid-configuration`
`GET https://api.aveid.net/.well-known/jwks.json`

### Userinfo

`GET https://api.aveid.net/api/oauth/userinfo`

## Common Integration Mistakes

1. **Wrong API URL:** Use `https://api.aveid.net/api/oauth/token`, NOT `https://aveid.net/api/oauth/token`
2. **Wrong field names in token request:** Use camelCase (`grantType`, `clientId`, `clientSecret`, `redirectUri`, `codeVerifier`), NOT snake_case
3. **Expecting JWT only:** Ave returns opaque + JWT tokens; use the one you need
4. **Storing profile data locally:** User profile (avatar, name) is managed by Ave. Fetch fresh data on login or link to Ave for profile edits.

## Contact

Need help? Contact us at hello@lantharos.com

